<html>

<head>
    <title>Varkes App Connector</title>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link href="css/jsoneditor.min.css" rel="stylesheet" type="text/css">
    <script src="js/json.editor.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
</head>

<body>
    <h1>Varkes App Connector</h1>

    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
        <input class="mdl-textfield__input" type="text" id="input">
        <label class="mdl-textfield__label" for="sample3">Token URL</label>

    </div>
    <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="create_service" onclick="giveToken()">
        Send
    </button>
    <div id="services">
        <ul class="demo-list-item mdl-list" style="float:left">

        </ul>
    </div>
    <div style="float:right">

        <div id="jsoneditor" style="width: 400px; height: 400px;"></div>

        <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="create_service" onclick="createService()">Create
            Service
        </button>
    </div>

    <script>
        $(document).ready(function () {
            getServices()
        })

        function deleteService(serviceID) {
            $.ajax({
                url: `/services/${serviceID}`,
                type: "DELETE",
                success: function (data) {
                    getServices()
                }
            })
        }
        function getServices() {
            $("#services ul").empty()
            console.log("get Services called")
            $.ajax(
                {
                    type: "get",
                    url: "/services",
                    success: function (data) {
                        data.forEach(element => {
                            $("#services ul").append
                                (`
                                <li class="mdl-list__item">
                <span class="mdl-list__item-primary-content">
                   ${element.id}
                </span>
                <a href="#" onClick=showService('${element.id}')>Show</a> 
                <a href="#" onClick="updateService('${element.id}')">Update</a> 
                <a href="#" onClick="deleteService('${element.id}')">Delete</a>
                                </li>`)
                        });
                    }

                }
            ).fail(function (xhr, options, error) {
                $("#services ul").text("No certificate defined, please provide a token url")
            })
        }

        function createService() {
            $.ajax({
                type: "POST",
                url: "/services",
                data: JSON.stringify(editor.get()),
                success: function (data) {
                    console.log(data)
                    getServices()
                },
                contentType: "application/json"
            }

            )
        }

        function updateService(serviceId) {
            $.ajax({
                type: "PUT",
                url: `/services/${serviceId}`,
                data: JSON.stringify(editor.get()),
                success: function (data) {
                    console.log(data)
                    getServices()
                },
                contentType: "application/json"
            })
        }
        function giveToken() {
            $.ajax({
                type: "POST",
                url: "/startConn",
                data: `{ "url": "${$("#input").val()}" }`,
                success: function (data) {

                    getServices()
                },
                contentType: "application/json"
            }

            )
        }

        function showService(serviceID) {
            $.ajax({
                type: "get",
                url: `/services/${serviceID}`,
                success: function (data) {
                    $("#serviceJSON").val(JSON.stringify(data))
                    editor.set(data)
                }
            })
        }



        var container = document.getElementById("jsoneditor");
        var options = {};
        var editor = new JSONEditor(container, options);

        // set json
        var json = {
            "provider": "SAP Hybris",
            "name": "ec-mock-service-4",
            "description": "testing... 1.2.3.",
            "api": {
                "targetUrl": "http://localhost/target",
                "credentials": {
                    "oauth": {
                        "url": "http://localhost/oauth/validate",
                        "clientId": "string",
                        "clientSecret": "string"
                    }
                },
                "spec": {}
            },
            "events": {
                "spec": {}
            },
            "documentation": {
                "displayName": "string",
                "description": "string",
                "type": "string",
                "tags": [
                    "string"
                ],
                "docs": [
                    {
                        "title": "string",
                        "type": "string",
                        "source": "string"
                    }
                ]
            }

        };
        editor.set(json);

        // get json
        var json = editor.get();
    </script>
</body>

</html>